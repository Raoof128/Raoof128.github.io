# Quality Testing Workflow
#
# Runs advanced quality tests:
# - Property-based/Fuzz testing
# - Performance regression tests
# - Web E2E tests (Playwright)
#
# Triggered on PRs and pushes to main

name: Quality Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Manual trigger

env:
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.daemon=false"

jobs:
  # ==========================================================================
  # PROPERTY-BASED / FUZZ TESTS
  # ==========================================================================
  fuzz-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Run Property-Based Tests
        run: ./gradlew :common:allTests --tests "*PropertyBasedTests*"
        
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-test-results
          path: common/build/reports/tests/

  # ==========================================================================
  # PERFORMANCE REGRESSION TESTS
  # ==========================================================================
  performance-tests:
    name: Performance Regression Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Run Performance Regression Tests
        run: ./gradlew :common:allTests --tests "*PerformanceRegressionTest*"
        
      - name: Run Benchmark Tests
        run: ./gradlew :common:allTests --tests "*Benchmark*"
        
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-results
          path: common/build/reports/tests/

  # ==========================================================================
  # WEB E2E TESTS (PLAYWRIGHT)
  # ==========================================================================
  e2e-tests:
    name: Web E2E Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webApp/e2e/package-lock.json

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Build Web App
        run: ./gradlew :webApp:jsBrowserProductionWebpack

      - name: Install E2E Dependencies
        working-directory: webApp/e2e
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: webApp/e2e
        run: npx playwright install --with-deps chromium firefox

      - name: Run Playwright Tests
        working-directory: webApp/e2e
        run: npx playwright test --reporter=github,html
        env:
          BASE_URL: http://localhost:8080
          CI: true

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: webApp/e2e/playwright-report/
          retention-days: 14

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: webApp/e2e/test-results/

  # ==========================================================================
  # IOS UI TESTS (MACOS ONLY)
  # ==========================================================================
  ios-ui-tests:
    name: iOS UI Tests
    runs-on: macos-14
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    # Only run on main due to macOS runner costs
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Build Common Framework for iOS
        run: ./gradlew :common:linkReleaseFrameworkIosSimulatorArm64

      - name: Copy Framework
        run: |
          mkdir -p iosApp/Frameworks
          cp -R common/build/bin/iosSimulatorArm64/releaseFramework/common.framework iosApp/Frameworks/

      - name: Run iOS UI Tests
        working-directory: iosApp
        run: |
          xcodebuild test \
            -scheme QRShield \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.2' \
            -resultBundlePath TestResults.xcresult \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty || true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-ui-test-results
          path: iosApp/TestResults.xcresult/

  # ==========================================================================
  # QUALITY SUMMARY
  # ==========================================================================
  quality-summary:
    name: Quality Summary
    needs: [fuzz-tests, performance-tests, e2e-tests]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check Test Results
        run: |
          echo "## Quality Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Property-Based Tests | ${{ needs.fuzz-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance Tests | ${{ needs.performance-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          
      - name: Fail if any test failed
        if: contains(needs.*.result, 'failure')
        run: exit 1
