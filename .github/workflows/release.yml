name: Release Build & Deploy

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.1.0)'
        required: true
        default: '1.1.0'
      prerelease:
        description: 'Mark as pre-release'
        type: boolean
        default: false

env:
  JAVA_VERSION: '17'
  GRADLE_OPTS: -Dorg.gradle.daemon=false

jobs:
  # ============================================
  # Build Signed Release APK
  # ============================================
  build-android-release:
    name: Build Signed Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: gradle

    - name: Decode Keystore
      id: decode_keystore
      uses: timheuer/base64-to-file@v1.2
      with:
        fileName: 'release-keystore.jks'
        fileDir: './androidApp'
        encodedString: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

    - name: Create keystore.properties
      run: |
        echo "storeFile=release-keystore.jks" > keystore.properties
        echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> keystore.properties
        echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> keystore.properties
        echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> keystore.properties

    - name: Build Release APK
      run: ./gradlew :androidApp:assembleRelease --no-daemon

    - name: Build Release Bundle (AAB)
      run: ./gradlew :androidApp:bundleRelease --no-daemon

    - name: Rename artifacts
      run: |
        VERSION=${{ github.event.inputs.version || github.ref_name }}
        VERSION=${VERSION#v}
        mkdir -p release-artifacts
        cp androidApp/build/outputs/apk/release/androidApp-release.apk release-artifacts/QRShield-${VERSION}-release.apk
        cp androidApp/build/outputs/bundle/release/androidApp-release.aab release-artifacts/QRShield-${VERSION}-release.aab

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: android-release-apk
        path: release-artifacts/QRShield-*-release.apk
        retention-days: 30

    - name: Upload Release AAB
      uses: actions/upload-artifact@v4
      with:
        name: android-release-aab
        path: release-artifacts/QRShield-*-release.aab
        retention-days: 30

  # ============================================
  # Build Desktop Artifacts
  # ============================================
  build-desktop:
    name: Build Desktop Apps
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: macos
          - os: windows-latest
            platform: windows
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: gradle

    - name: Build Desktop Package
      run: ./gradlew :desktopApp:packageUberJarForCurrentOS --no-daemon
      shell: bash

    - name: Upload Desktop Artifact
      uses: actions/upload-artifact@v4
      with:
        name: desktop-${{ matrix.platform }}
        path: desktopApp/build/compose/jars/*.jar
        retention-days: 30

  # ============================================
  # Build iOS Framework
  # ============================================
  build-ios-framework:
    name: Build iOS Release Framework
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: gradle

    - name: Build Release Framework (arm64)
      run: ./gradlew :common:linkReleaseFrameworkIosArm64 --no-daemon

    - name: Build Release Framework (Simulator arm64)
      run: ./gradlew :common:linkReleaseFrameworkIosSimulatorArm64 --no-daemon

    - name: Upload iOS Framework
      uses: actions/upload-artifact@v4
      with:
        name: ios-release-framework
        path: |
          common/build/bin/iosArm64/releaseFramework/
          common/build/bin/iosSimulatorArm64/releaseFramework/
        retention-days: 30

  # ============================================
  # Create GitHub Release
  # ============================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-android-release, build-desktop, build-ios-framework]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Android APK
      uses: actions/download-artifact@v4
      with:
        name: android-release-apk
        path: ./release

    - name: Download Linux Desktop
      uses: actions/download-artifact@v4
      with:
        name: desktop-linux
        path: ./release/linux

    - name: Download macOS Desktop
      uses: actions/download-artifact@v4
      with:
        name: desktop-macos
        path: ./release/macos

    - name: Download Windows Desktop
      uses: actions/download-artifact@v4
      with:
        name: desktop-windows
        path: ./release/windows

    - name: Prepare release artifacts
      run: |
        VERSION=${{ github.event.inputs.version || github.ref_name }}
        VERSION=${VERSION#v}
        
        # Rename desktop JARs
        mv ./release/linux/*.jar ./release/QRShield-${VERSION}-linux.jar 2>/dev/null || true
        mv ./release/macos/*.jar ./release/QRShield-${VERSION}-macos.jar 2>/dev/null || true
        mv ./release/windows/*.jar ./release/QRShield-${VERSION}-windows.jar 2>/dev/null || true
        
        # Clean up empty directories
        rm -rf ./release/linux ./release/macos ./release/windows

    - name: Get Release Version
      id: get_version
      run: |
        VERSION=${{ github.event.inputs.version || github.ref_name }}
        echo "version=${VERSION#v}" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.get_version.outputs.version }}
        name: QR-SHIELD v${{ steps.get_version.outputs.version }}
        prerelease: ${{ github.event.inputs.prerelease || false }}
        generate_release_notes: true
        files: |
          ./release/QRShield-*.apk
          ./release/QRShield-*.jar
        body: |
          ## ğŸ›¡ï¸ QR-SHIELD v${{ steps.get_version.outputs.version }}
          
          **Protect yourself from QRishing attacks with intelligent QR code scanning.**
          
          ---
          
          ### ğŸ“± Download
          
          | Platform | Download | Requirements |
          |----------|----------|--------------|
          | **Android** | [`QRShield-${{ steps.get_version.outputs.version }}-release.apk`](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/QRShield-${{ steps.get_version.outputs.version }}-release.apk) | Android 8.0+ (API 26) |
          | **iOS** | ğŸ Coming Soon | iOS 17.0+ |
          | **Desktop (Linux)** | `QRShield-${{ steps.get_version.outputs.version }}-linux.jar` | JRE 17+ |
          | **Desktop (macOS)** | `QRShield-${{ steps.get_version.outputs.version }}-macos.jar` | JRE 17+ |
          | **Desktop (Windows)** | `QRShield-${{ steps.get_version.outputs.version }}-windows.jar` | JRE 17+ |
          | **Web** | [ğŸŒ Try Online Demo](https://raoof128.github.io/QDKMP-KotlinConf-2026-/) | Modern browser |
          
          ---
          
          ### ğŸš€ Installation
          
          #### Android
          1. Download `QRShield-${{ steps.get_version.outputs.version }}-release.apk`
          2. Enable "Install from unknown sources" in Settings
          3. Open the APK file to install
          
          #### Desktop
          ```bash
          # Run with Java 17+
          java -jar QRShield-${{ steps.get_version.outputs.version }}-<platform>.jar
          ```
          
          ---
          
          ### âœ¨ Features
          
          - ğŸ” **25+ Security Heuristics** - Comprehensive URL analysis
          - ğŸ¤– **ML-Powered Detection** - On-device phishing scoring
          - ğŸ¢ **Brand Impersonation Detection** - 500+ brands monitored
          - ğŸ”’ **100% Offline** - No data leaves your device
          - ğŸŒ **Cross-Platform** - Android, iOS, Desktop, Web
          
          ---
          
          ### ğŸ” Security
          
          This release is signed with a verified signing key:
          - **SHA-256**: Verify with `sha256sum QRShield-*.apk`
          - No internet permission required for basic scanning
          - No data collection or telemetry
          
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
